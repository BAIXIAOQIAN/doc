## MQTT协议

### MQTT协议是什么
> MQTT是一个客户端服务端结构的`发布/订阅`模式的消息传输协议。
- 设计思想: 轻巧、开放、简单、规范、易于实现
- 应用场景: 机器与机器的通信(M2M)、物联网环境(IOT)

### MQTT控制报文的结构

MQTT控制报文由三部分组成:

|字段名|描述|
|---|---|
|Fixed header | 固定报头，所有控制报文都包含 |
|Variable header | 可变报头，部分控制报文包含 |
|Payload | 有效载荷，部分控制报文包含 |

#### 固定报头(Fixed header)
> 每个MQTT控制报文都包含一个固定报头。

![](./image/mqtt_fixed_haeder.png)

##### MQTT控制报文的类型(MQTT Control Packet type)

- 位置: Byte1中bits 7-4 ,表示为4位无符号值

![](./image/mqtt_control_packet_type.png)

##### 标志(Flags)

- 位置: Byte1中bits 3-0

- 在不使用标识位的消息类型中，标识位被作为保留位。如果收到无效的标志时，接收端必须关闭网络连接。

![](./image/mqtt_flags.png)

```
- DUP: 发布消息的副本。用来在保证消息的可靠传输，如果设置为1，则在下面的变长中增加MessageId,并且需要回复确认，
以保证消息传输完成，但不能用于检测消息重复发送。

- Qos: 发布消息的服务质量，即: 保证消息传递的次数
     00: 至多一次，即: <= 1
     01: 至少一次，即: >= 1
     11: 只有一次，即: == 1
     11: 预留

- RETAIN: 发布保留标识，表示服务器要保留这次推送的信息，如果有新的订阅者出现，就把这消息推送给它，如果没有，
那么推送至当前订阅者后释放。
```
##### 剩余长度(Remaining Length)

- 位置: 从第二个字节(Byte2)开始

- 剩余长度表示当前报文剩余部分的字节数，包括可变报头和负载的数据。剩余长度不包括用于编码剩余长度字段本身的字节数。